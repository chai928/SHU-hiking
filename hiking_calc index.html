<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–æ–°ç™»å±±ç¤¾éšŠä¼è¨ˆç®—æ©Ÿ V4.0</title>
    <style>
        :root {
            --primary: #2c7a7b; /* ä¸–æ–°ç¶ (?) */
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --border: #e2e8f0;
            --highlight: #ebf8ff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            gap: 20px;
        }
        /* é ‚éƒ¨å°è¦½åˆ— */
        .header-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-left: 5px solid var(--primary);
        }
        h1 { margin: 0; font-size: 1.6rem; color: var(--primary); }
        .team-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.2s;
        }
        .btn-new { background-color: #48bb78; color: white; }
        .btn-del { background-color: #f56565; color: white; }
        .btn-save { 
            background-color: var(--primary); color: white; 
            width: 100%; margin-top: 20px; padding: 15px; font-size: 18px;
        }
        .btn-save:hover { background-color: #234e52; }

        /* ä¸»è¦å…§å®¹ä½ˆå±€ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 1rem;
            color: #4a5568;
            font-weight: 800;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-badge {
            font-size: 0.75rem;
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 10px;
            color: #718096;
            font-weight: normal;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: span 2; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #4a5568; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--primary); outline: none; background-color: #fafdff; }
        
        .auto-calc-field {
            background-color: #f7fafc;
            color: #718096;
            border: 1px dashed #cbd5e0;
            cursor: not-allowed;
        }

        /* çµæœå±•ç¤ºå€ */
        .result-group {
            margin-bottom: 20px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .result-header {
            background: #edf2f7;
            padding: 10px 15px;
            font-weight: bold;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid #f7fafc;
            font-size: 15px;
        }
        .result-row:last-child { border-bottom: none; }
        .highlight-price { color: var(--primary); font-weight: bold; font-size: 1.1em; }
        
        .total-cost-display {
            text-align: center;
            color: #e53e3e;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .btn-copy {
            background-color: #4a5568;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-panel">
        <h1>â›°ï¸ ä¸–æ–°ç™»å±±ç¤¾éšŠä¼è¨ˆç®—æ©Ÿ V4.0</h1>
        <div class="team-controls">
            <select id="teamSelector" onchange="loadTeamData()"></select>
            <button class="btn-new" onclick="createNewTeam()">ï¼‹ æ–°éšŠä¼</button>
            <button class="btn-del" onclick="deleteTeam()">ğŸ—‘ åˆªé™¤</button>
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            
            <div class="section-title">
                1. éšŠä¼è³‡æ–™
                <span class="section-badge">å„²å­˜ç”¨</span>
            </div>
            <div class="form-group">
                <label>éšŠä¼åç¨±</label>
                <input type="text" id="team_name" placeholder="ä¾‹ï¼šé›ªå±±ä¸»æ±è–èª•éšŠ" oninput="updateTeamNameInSelect()">
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>é ˜éšŠå§“å</label>
                    <input type="text" id="leader_name" placeholder="ä¾‹ï¼šæ—å°æ˜">
                </div>
                <div class="form-group">
                    <label>å‡ºéšŠæ—¥æœŸ</label>
                    <input type="date" id="start_date">
                </div>
            </div>

            <div class="section-title">2. äººæ•¸èˆ‡å¤©æ•¸è¦æ ¼</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>é è¨ˆå¤©æ•¸</label>
                    <input type="number" id="days" placeholder="å¤©" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>å…¬ç³§é¤æ•¸</label>
                    <input type="number" id="meals" placeholder="é¤" onchange="calculate()">
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>éšŠå“¡äººæ•¸</label>
                    <input type="number" id="cnt_member" placeholder="äºº" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>åš®å°äººæ•¸</label>
                    <input type="number" id="cnt_guide" placeholder="äºº" onchange="calculate()">
                </div>
                <div class="form-group full-width">
                    <label>é ˜éšŠäººæ•¸ (é€šå¸¸1äºº)</label>
                    <input type="number" id="cnt_leader" value="1" placeholder="äºº" onchange="calculate()">
                </div>
            </div>

            <div class="section-title">3. å¤–éƒ¨æˆæœ¬ (å¯¦å ±å¯¦éŠ·)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>åŒ…è»Šè»Šè³‡</label>
                    <input type="number" id="cost_car" value="0" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>è£å‚™ç§Ÿå€Ÿ (å¤–éƒ¨)</label>
                    <input type="number" id="cost_rent_ext" value="0" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>ç¤¾åœ˜è£å‚™ (å…§éƒ¨)</label>
                    <input type="number" id="cost_rent_int" value="0" onchange="calculate()">
                </div>
                <div class="form-group">
                    <label>ç“¦æ–¯è²»ç”¨</label>
                    <input type="number" id="cost_gas" value="0" onchange="calculate()">
                </div>
                <div class="form-group full-width">
                    <label>å±±å±‹/ä½å®¿è²»ç”¨</label>
                    <input type="number" id="cost_cabin" value="0" onchange="calculate()">
                </div>
            </div>

            <button class="btn-save" onclick="saveCurrentTeam()">ğŸ’¾ å„²å­˜éšŠä¼è³‡æ–™</button>
        </div>

        <div class="card">
            <div class="section-title">
                4. è‡ªå‹•è¨ˆç®—å›ºå®šæˆæœ¬
                <span class="section-badge">ç³»çµ±è‡ªå‹•å¸¶å…¥</span>
            </div>
            <div class="result-group" style="background: #f9f9f9;">
                <div class="result-row"><span>é£Ÿæè²» ($100/é¤/äºº)</span><span id="disp_food">$0</span></div>
                <div class="result-row"><span>ä¿éšªè²» ($50/å¤©/äºº)</span><span id="disp_insurance">$0</span></div>
                <div class="result-row"><span>å±±é˜²åŸºé‡‘ ($30/äºº)</span><span id="disp_defense">$0</span></div>
                <div class="result-row"><span>é†«è—¥åŸºé‡‘ ($30/äºº)</span><span id="disp_medical">$0</span></div>
            </div>

            <div class="section-title">ğŸ’° æœ€çµ‚éšŠè²»å ±åƒ¹</div>
            
            <div class="result-group" style="border-color: var(--primary);">
                <div class="result-header">æ”¶è²»æ¨™æº–</div>
                <div class="result-row">
                    <span>ä¸€èˆ¬éšŠå“¡</span>
                    <span class="highlight-price" id="final_member">$0</span>
                </div>
                <div class="result-row">
                    <span>åš®å° (å…±åˆ†æ”¤$1000å„ªæƒ )</span>
                    <span class="highlight-price" id="final_guide">$0</span>
                </div>
                <div class="result-row">
                    <span>é ˜éšŠ (å„ªæƒ $1000)</span>
                    <span class="highlight-price" id="final_leader">$0</span>
                </div>
            </div>

            <div class="total-cost-display">
                * æœ¬æ¬¡æ´»å‹•ç¸½æ”¯å‡ºé ä¼°ï¼š<span id="total_cost_check">$0</span>
            </div>

            <button class="btn-copy" onclick="copyResult()">ğŸ“‹ è¤‡è£½å ±åƒ¹å–®</button>
        </div>
    </div>
</div>

<script>
    let allTeams = {};
    let currentTeamId = null;

    window.onload = function() {
        const savedData = localStorage.getItem('shih_hsin_hiking_v4');
        if (savedData) {
            allTeams = JSON.parse(savedData);
        } else {
            createNewTeamData('é è¨­éšŠä¼');
        }
        renderTeamSelector();
        
        // è®€å–ä¸Šæ¬¡æ“ä½œçš„ ID
        const lastId = localStorage.getItem('last_active_team_v4');
        if (lastId && allTeams[lastId]) {
            currentTeamId = lastId;
        } else {
            currentTeamId = Object.keys(allTeams)[0];
        }
        
        document.getElementById('teamSelector').value = currentTeamId;
        loadTeamData();
    };

    function createNewTeamData(name) {
        const id = 'team_' + Date.now();
        allTeams[id] = {
            name: name,
            leader_name: '',
            start_date: '',
            days: '',
            meals: '',
            cnt_member: '',
            cnt_guide: '',
            cnt_leader: 1,
            cost_car: '',
            cost_rent_ext: '',
            cost_rent_int: '',
            cost_gas: '',
            cost_cabin: ''
        };
        return id;
    }

    function createNewTeam() {
        const name = prompt("è«‹è¼¸å…¥æ–°éšŠä¼åç¨±ï¼š", "æœªå‘½åéšŠä¼");
        if(name) {
            const newId = createNewTeamData(name);
            saveToLocalStorage();
            renderTeamSelector();
            document.getElementById('teamSelector').value = newId;
            currentTeamId = newId;
            loadTeamData();
        }
    }

    function deleteTeam() {
        if (Object.keys(allTeams).length <= 1) {
            alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹éšŠä¼ï¼");
            return;
        }
        if (confirm("ç¢ºå®šè¦åˆªé™¤ç›®å‰çš„éšŠä¼å—ï¼Ÿ")) {
            delete allTeams[currentTeamId];
            currentTeamId = Object.keys(allTeams)[0];
            saveToLocalStorage();
            renderTeamSelector();
            document.getElementById('teamSelector').value = currentTeamId;
            loadTeamData();
        }
    }

    function renderTeamSelector() {
        const selector = document.getElementById('teamSelector');
        selector.innerHTML = '';
        // ä¾æ“šå»ºç«‹æ™‚é–“æ’åº (ID å«æœ‰ timestamp)
        Object.keys(allTeams).sort().forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.text = allTeams[id].name;
            selector.appendChild(option);
        });
    }

    function updateTeamNameInSelect() {
        const newName = document.getElementById('team_name').value;
        allTeams[currentTeamId].name = newName;
        const selector = document.getElementById('teamSelector');
        selector.options[selector.selectedIndex].text = newName;
    }

    function loadTeamData() {
        const selector = document.getElementById('teamSelector');
        currentTeamId = selector.value;
        const data = allTeams[currentTeamId];

        // å¡«å…¥æ‰€æœ‰æ¬„ä½
        document.getElementById('team_name').value = data.name || '';
        document.getElementById('leader_name').value = data.leader_name || '';
        document.getElementById('start_date').value = data.start_date || '';
        document.getElementById('days').value = data.days;
        document.getElementById('meals').value = data.meals;
        document.getElementById('cnt_member').value = data.cnt_member;
        document.getElementById('cnt_guide').value = data.cnt_guide;
        document.getElementById('cnt_leader').value = data.cnt_leader;
        
        document.getElementById('cost_car').value = data.cost_car;
        document.getElementById('cost_rent_ext').value = data.cost_rent_ext;
        document.getElementById('cost_rent_int').value = data.cost_rent_int;
        document.getElementById('cost_gas').value = data.cost_gas;
        document.getElementById('cost_cabin').value = data.cost_cabin;

        localStorage.setItem('last_active_team_v4', currentTeamId);
        calculate();
    }

    function saveCurrentTeam() {
        const data = allTeams[currentTeamId];
        data.name = document.getElementById('team_name').value;
        data.leader_name = document.getElementById('leader_name').value;
        data.start_date = document.getElementById('start_date').value;
        data.days = document.getElementById('days').value;
        data.meals = document.getElementById('meals').value;
        data.cnt_member = document.getElementById('cnt_member').value;
        data.cnt_guide = document.getElementById('cnt_guide').value;
        data.cnt_leader = document.getElementById('cnt_leader').value;
        
        data.cost_car = document.getElementById('cost_car').value;
        data.cost_rent_ext = document.getElementById('cost_rent_ext').value;
        data.cost_rent_int = document.getElementById('cost_rent_int').value;
        data.cost_gas = document.getElementById('cost_gas').value;
        data.cost_cabin = document.getElementById('cost_cabin').value;

        saveToLocalStorage();
        calculate();
        alert("âœ… éšŠä¼è³‡æ–™å·²å„²å­˜ï¼");
    }

    function saveToLocalStorage() {
        localStorage.setItem('shih_hsin_hiking_v4', JSON.stringify(allTeams));
    }

    function getNum(id) {
        return parseFloat(document.getElementById(id).value) || 0;
    }

    function fmt(num) {
        return "$" + Math.round(num).toLocaleString();
    }

    function calculate() {
        // 1. å–å¾—åƒæ•¸
        const days = getNum('days');
        const meals = getNum('meals');
        const cnt_m = getNum('cnt_member');
        const cnt_g = getNum('cnt_guide');
        const cnt_l = getNum('cnt_leader');
        const total_people = cnt_m + cnt_g + cnt_l;

        // 2. å¤–éƒ¨æˆæœ¬ç¸½å’Œ
        const c_car = getNum('cost_car');
        const c_rent_ext = getNum('cost_rent_ext');
        const c_rent_int = getNum('cost_rent_int');
        const c_gas = getNum('cost_gas');
        const c_cabin = getNum('cost_cabin');
        const total_variable_cost = c_car + c_rent_ext + c_rent_int + c_gas + c_cabin;

        // 3. è‡ªå‹•è¨ˆç®—å›ºå®šæˆæœ¬
        // é£Ÿæï¼šé¤æ•¸ * 100 * ç¸½äººæ•¸
        const cost_food = meals * 100 * total_people;
        // ä¿éšªï¼šå¤©æ•¸ * 50 * ç¸½äººæ•¸
        const cost_ins = days * 50 * total_people;
        // å±±é˜² & é†«è—¥ï¼š 30 * ç¸½äººæ•¸
        const cost_def = 30 * total_people;
        const cost_med = 30 * total_people;

        // æ›´æ–°ä»‹é¢é¡¯ç¤º (è‡ªå‹•è¨ˆç®—éƒ¨åˆ†)
        document.getElementById('disp_food').innerText = fmt(cost_food);
        document.getElementById('disp_insurance').innerText = fmt(cost_ins);
        document.getElementById('disp_defense').innerText = fmt(cost_def);
        document.getElementById('disp_medical').innerText = fmt(cost_med);

        // 4. è¨ˆç®—ç¸½æ”¯å‡º
        const total_cost = total_variable_cost + cost_food + cost_ins + cost_def + cost_med;
        document.getElementById('total_cost_check').innerText = fmt(total_cost);

        if (total_people === 0) return;

        // 5. éšŠè²»æ‹†åˆ†æ ¸å¿ƒé‚è¼¯
        // é‚è¼¯ï¼šç¸½æ”¶å…¥å¿…é ˆç­‰æ–¼ç¸½æ”¯å‡º (Total Revenue = Total Cost)
        // è¨­åŸºæº–éšŠè²»ç‚º X
        // é ˜éšŠä»˜ï¼š X - 1000
        // åš®å°ä»˜ï¼š X - (1000 / åš®å°äººæ•¸)
        // éšŠå“¡ä»˜ï¼š X
        // æ–¹ç¨‹å¼ï¼š (cnt_l * (X-1000)) + (cnt_g * (X - 1000/cnt_g)) + (cnt_m * X) = Total Cost
        // å±•é–‹ï¼š (cnt_l * X) - (cnt_l * 1000) + (cnt_g * X) - 1000 + (cnt_m * X) = Total Cost
        // å±•é–‹ï¼š (Total People * X) - (cnt_l * 1000) - 1000 = Total Cost
        // ç§»é …ï¼š X = (Total Cost + 1000 + (cnt_l * 1000)) / Total People
        
        // ä½ çš„è¦å‰‡ï¼šé ˜éšŠå„ªæƒ 1000ï¼Œåš®å°ä¾äººæ•¸åˆ†é…1000ã€‚
        // æ‰€ä»¥ç¸½å„ªæƒ é¡åº¦ = (cnt_l * 1000) + 1000
        // å¦‚æœé ˜éšŠåªæœ‰1äººï¼Œé‚£å°±æ˜¯ ç¸½æˆæœ¬ + 2000 é™¤ä»¥ ç¸½äººæ•¸ = åŸºæº–è²» X
        
        const total_discount_needed = (cnt_l * 1000) + 1000;
        const base_fee = (total_cost + total_discount_needed) / total_people;

        // è¨ˆç®—å„èº«ä»½è²»ç”¨
        const fee_member = base_fee;
        const fee_leader = base_fee - 1000;
        // åš®å°å„ªæƒ æ˜¯å¹³åˆ†é‚£1000å…ƒ
        const guide_discount_per_person = cnt_g > 0 ? (1000 / cnt_g) : 0;
        const fee_guide = base_fee - guide_discount_per_person;

        // æ›´æ–° UI
        document.getElementById('final_member').innerText = fmt(fee_member);
        document.getElementById('final_leader').innerText = fmt(fee_leader);
        document.getElementById('final_guide').innerText = fmt(fee_guide);
    }

    function copyResult() {
        const d = allTeams[currentTeamId];
        // æŠ“å–å‰›å‰›è¨ˆç®—çš„æ•¸å­—
        const f_m = document.getElementById('final_member').innerText;
        const f_g = document.getElementById('final_guide').innerText;
        const f_l = document.getElementById('final_leader').innerText;
        const total = document.getElementById('total_cost_check').innerText;

        const text = 
`ã€ä¸–æ–°ç™»å±±ç¤¾ - éšŠè²»å ±åƒ¹å–®ã€‘
------------------------
éšŠä¼åç¨±ï¼š${document.getElementById('team_name').value}
é ˜éšŠï¼š${document.getElementById('leader_name').value}
æ—¥æœŸï¼š${document.getElementById('start_date').value}
è¦æ ¼ï¼š${d.days}å¤© / å…¬ç³§${d.meals}é¤
äººæ•¸ï¼šéšŠå“¡${d.cnt_member} / åš®å°${d.cnt_guide} / é ˜éšŠ${d.cnt_leader}
------------------------
ğŸ’° æ¯äººæ‡‰ç¹³éšŠè²»ï¼š
â— éšŠå“¡ï¼š${f_m}
â— åš®å°ï¼š${f_g}
â— é ˜éšŠï¼š${f_l}

(æœ¬éšŠé ä¼°ç¸½æ”¯å‡ºï¼š${total})
------------------------`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert("å ±åƒ¹å–®å·²è¤‡è£½ï¼");
        });
    }
</script>

</body>
</html>